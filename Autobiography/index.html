<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trần Thị Kim Chi - Trang Cá Nhân</title>
<style>
  /* Reset and base */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #a6c0fe, #f68084);
    color: #333;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
    position: relative;
    background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-4.0.3&amp;auto=format&amp;fit=crop&amp;w=1470&amp;q=80');
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center center;
  }
  #shooting-stars-container {
    pointer-events: none;
    position: fixed;
    inset: 0;
    z-index: 9999;
    overflow: visible;
  }
  .shooting-star {
    position: absolute;
    width: 150px;
    height: 2px;
    background: linear-gradient(90deg, #fff, transparent);
    opacity: 0.8;
    border-radius: 999px;
    filter: drop-shadow(0 0 3px #cceeff);
    animation-timing-function: ease-in-out;
  }

  /* Snowflake styles */
  .snowflake {
    pointer-events: none;
    position: fixed;
    top: -10px;
    color: white;
    font-size: 1.5rem;
    user-select: none;
    z-index: 10000;
    animation-name: fall, sway;
    animation-timing-function: linear, ease-in-out;
    animation-iteration-count: infinite;
  }
  @keyframes fall {
    0% {transform: translateY(0);opacity: 0.8;}
    100% {transform: translateY(100vh);opacity: 0;}
  }
  @keyframes sway {
    0%, 100% {transform: translateX(0);}
    50% {transform: translateX(20px);}
  }

  header {
    background-color: rgba(31, 56, 103, 0.8);
    color: white;
    padding: 1rem 2rem;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    position: relative;
    z-index: 10;
    user-select: none;
  }
  header h1 {
    margin-bottom: 0.2rem;
    font-weight: 700;
    font-size: 2.2rem;
    letter-spacing: 1.5px;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
  }
  header .contact-info {
    margin-top: 6px;
    font-size: 0.95rem;
    font-weight: 500;
    color: #ffc107;
  }
  header .contact-info a {
    color: #ffc107;
    text-decoration: none;
  }
  header .contact-info a:hover {
    text-decoration: underline;
  }
  nav {
    margin-top: 0.5rem;
  }
  nav ul {
    list-style: none;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  nav ul li {
    position: relative;
  }
  nav ul li button {
    background: none;
    border: none;
    color: #ffc107;
    font-weight: 600;
    cursor: pointer;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    font-size: 1rem;
  }
  nav ul li button:hover,
  nav ul li button.active {
    color: #1e3c72;
    background-color: #ffc107;
    box-shadow: 0 0 8px #ffc107;
  }
  /* Dropdown content */
  .dropdown-content {
    display: none;
    position: absolute;
    top: 130%;
    left: 0;
    background: rgba(255 255 255 / 0.9);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    z-index: 20;
    min-width: 220px;
    max-width: 300px;
    color: #222;
    padding: 1rem;
  }
  .dropdown-content.active {
    display: block;
  }
  /* Style for social links */
  .social-links {
    margin-top: 0.5rem;
    display: flex;
    gap: 1rem;
  }
  .social-links a {
    background: rgba(255 255 255 / 0.15);
    padding: 0.4rem 0.6rem;
    border-radius: 50%;
    color: #ffc107;
    font-size: 1.8rem;
    transition: transform 0.3s ease, background-color 0.3s ease;
    box-shadow: 0 0 10px rgba(255, 202, 40, 0.7);
  }
  .social-links a:hover {
    background: rgba(255 255 255 / 0.35);
    transform: scale(1.15);
    color: #fff176;
  }

  main {
    flex: 1;
    padding: 2rem 3rem;
    max-width: 1100px;
    margin: 2rem auto 4rem auto;
    background: rgba(255 255 255 / 0.15);
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.13);
    backdrop-filter: blur(8px);
    color: #222;
    user-select: text;
  }
  section {
    display: none;
  }
  section.active {
    display: block;
  }
  section h2 {
    color: #ffca28;
    margin-bottom: 1rem;
    font-size: 2rem;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
  }
  #projects ul {
    margin-left: 1.2rem;
    list-style-type: square;
    color: #ffeb3b;
    font-size: 1.2rem;
  }
  #uploaded-files li {
    background: rgba(255 255 255 / 0.25);
    border: 1px solid rgba(255 255 255 / 0.4);
    transition: background-color 0.3s ease;
    color: #222;
  }
  #uploaded-files li:hover {
    background: rgba(255 255 255 / 0.45);
  }
  button {
    font-weight: 600;
    border-radius: 8px;
    border: none;
    background-color: #ffca28;
    color: #1e3c72;
    padding: 0.6rem 1.4rem;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(255, 202, 40, 0.4);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background-color: #ffd54f;
    box-shadow: 0 6px 14px rgba(255, 214, 79, 0.7);
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    box-shadow: none;
  }
  input[type="file"], input[type="text"] {
    color: #ffca28;
    background: transparent;
    border: 1px solid #ffca28;
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    font-weight: 500;
    transition: background-color 0.3s ease, color 0.3s ease;
    outline-offset: 2px;
    outline-color: transparent;
  }
  input[type="file"]:hover, input[type="text"]:hover, input[type="text"]:focus {
    background-color: #ffca28;
    color: #1e3c72;
    outline-color: #ffd54f;
  }
  .game-container {
    background: rgba(255 255 255 / 0.25);
    box-shadow: 0 0 30px rgba(255 202, 40, 0.7);
    border-radius: 15px;
    padding: 1.5rem;
    transition: box-shadow 0.3s ease;
  }
  .game-container:hover {
    box-shadow: 0 0 40px rgba(255 202, 40, 0.9);
  }
  .bubble {
    box-shadow: 0 0 8px 2px #4dc6ff;
    cursor: pointer;
  }
  .bubble.pop {
    box-shadow: 0 0 15px 5px #ffca28;
    transform: scale(1.8);
    pointer-events: none;
  }
  .instructions {
    font-style: italic;
    text-align: center;
    margin-top: 0.8rem;
    color: #ffe066;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.5);
  }
  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(31, 56, 103, 0.9);
    color: #ffc107;
    padding: 0.75rem 1rem;
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    user-select: none;
  }
  #music-player label {
    white-space: nowrap;
    flex-shrink: 0;
    font-weight: 600;
  }
  #music-player input[type="text"] {
    flex-grow: 1;
    max-width: 600px;
    border-radius: 6px;
    border: none;
    padding: 0.3rem 0.6rem;
  }
  #music-player button {
    flex-shrink: 0;
    padding: 0.5rem 1rem;
    font-weight: 700;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    background-color: #ffca28;
    color: #1e3c72;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #music-player button:hover {
    background-color: #ffd54f;
  }
  @media (max-width: 600px) {
    main {
      padding: 1.5rem 1rem;
      margin: 1rem auto 4rem auto;
    }
    nav ul {
      justify-content: center;
    }
    nav ul li button {
      font-size: 1rem;
    }
    header h1 {
      font-size: 1.6rem;
    }
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<div id="shooting-stars-container"></div>
<header>
  <h1>Trần Thị Kim Chi</h1>
  <div class="contact-info" aria-label="Thông tin liên hệ">
    Số điện thoại: <a href="tel:0935074853" style="color:#ffc107; text-decoration:none;">0935074853</a> |
    Email: <a href="mailto:chi23675@gmail.com" style="color:#ffc107; text-decoration:none;">chi23675@gmail.com</a>
  </div>
  <div class="social-links" aria-label="Liên kết mạng xã hội">
    <a href="https://www.facebook.com/eomeoi03/" target="_blank" rel="noopener" title="Facebook"><i class="fab fa-facebook"></i></a>
    <a href="https://github.com/kimcheese23" target="_blank" rel="noopener" title="GitHub"><i class="fab fa-github"></i></a>
  </div>
  <nav aria-label="Menu điều hướng chính">
    <ul>
      <li>
        <button id="btn-biography" aria-expanded="true" aria-controls="biography">Tiểu Sử</button>
        <div id="biography-content" class="dropdown-content active" tabindex="0" aria-label="Nội dung tiểu sử">
          <p>Xin chào, tôi là <strong>Trần Thị Kim Chi</strong>. Tôi đam mê công nghệ, thiết kế và phát triển web. Qua các dự án và kinh nghiệm của mình, tôi luôn cố gắng tạo ra những sản phẩm sáng tạo và hữu ích. Tôi rất vui được chia sẻ những điều này với bạn tại trang cá nhân của mình.</p>
        </div>
      </li>
      <li>
        <button id="btn-projects" aria-expanded="false" aria-controls="projects">Dự Án</button>
        <div id="projects-content" class="dropdown-content" tabindex="0" aria-label="Nội dung dự án">
          <ul>
            <li>Website giới thiệu cá nhân tích hợp mini game tương tác</li>
            <li>Ứng dụng quản lý tài liệu cá nhân với giao diện thân thiện</li>
            <li>Game vượt chướng ngại vật đơn giản bằng Canvas và JavaScript</li>
            <li>Hệ thống phản hồi và lưu trữ tài liệu dựa trên trình duyệt</li>
          </ul>
        </div>
      </li>
      <li>
        <button id="btn-storage" aria-expanded="false" aria-controls="storage">Lưu Trữ Tài Liệu</button>
        <div id="storage-content" class="dropdown-content" tabindex="0" aria-label="Nội dung lưu trữ tài liệu">
          <div id="uploaded-files" aria-live="polite"><p>Không có tài liệu nào được tải lên.</p></div>
        </div>
      </li>
      <li>
        <button id="btn-upload" aria-expanded="false" aria-controls="upload">Tải Tài Liệu Lên</button>
        <div id="upload-content" class="dropdown-content" tabindex="0" aria-label="Nội dung tải tài liệu lên">
          <div id="upload-section">
            <p>Chọn tập tin để tải lên (chỉ lưu trữ trên trình duyệt).</p>
            <input type="file" id="file-input" aria-label="Chọn tập tin để tải lên" />
            <button id="upload-btn" type="button" aria-label="Nút tải lên">Tải lên</button>
            <p id="upload-status" role="alert" aria-live="polite"></p>
          </div>
        </div>
      </li>
      <li>
        <button id="btn-games" aria-expanded="false" aria-controls="games">Trò Chơi</button>
        <div id="games-content" class="dropdown-content" tabindex="0" aria-label="Nội dung trò chơi">
          <div id="games">
            <div class="game-container" aria-label="Trò chơi chạm bong bóng nổ">
              <h3>Chạm Bong Bóng Nổ</h3>
              <div id="bubble-game" aria-describedby="bubble-desc" tabindex="0" role="application"></div>
              <p id="bubble-desc" class="instructions" style="color:#1e3c72;">Nhấp hoặc chạm vào các bong bóng để tạo tiếng nổ. Bong bóng sẽ nổi lên từ dưới lên.</p>
              <p>Điểm: <span id="bubble-score">0</span></p>
              <button id="bubble-play" type="button" aria-label="Nút chơi trò bong bóng">Chơi</button>
              <button id="bubble-reset" type="button" aria-label="Nút chơi lại trò bong bóng" disabled>Chơi Lại</button>
            </div>
            <div class="game-container" aria-label="Trò chơi vượt chướng ngại vật">
              <h3>Vượt Chướng Ngại Vật (Mario Style)</h3>
              <canvas id="obstacle-canvas" width="460" height="300" role="application" aria-label="Canvas trò chơi vượt chướng ngại vật"></canvas>
              <p class="instructions" style="color:#e0e7ff;">Nhấn phím cách hoặc chạm để nhảy qua cây nấm.</p>
              <p>Điểm: <span id="obstacle-score">0</span></p>
              <button id="obstacle-play" type="button" aria-label="Nút chơi trò vượt chướng ngại vật">Chơi</button>
              <button id="obstacle-reset" type="button" aria-label="Nút chơi lại trò vượt chướng ngại vật" disabled>Chơi Lại</button>
            </div>
          </div>
        </div>
      </li>
    </ul>
  </nav>
</header>

<main></main>

<footer>
  <div id="music-player">
    <label for="music-url">Dán URL YouTube hoặc Spotify để phát nhạc:</label>
    <input type="text" id="music-url" placeholder="Ví dụ: https://www.youtube.com/watch?v=dQw4w9WgXcQ" aria-label="Nhập URL nhạc" />
    <button id="load-music" aria-label="Phát nhạc từ URL">Phát nhạc</button>
    <div id="music-container" aria-live="polite" aria-atomic="true" style="flex-grow:1;"></div>
    <label for="volume-control" style="white-space:nowrap;">Âm lượng:</label>
    <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.5" aria-label="Điều chỉnh âm lượng" />
  </div>
</footer>

<script>
  // Snowflake creation
  function createSnowflake() {
    const snowflake = document.createElement('div');
    snowflake.classList.add('snowflake');
    snowflake.textContent = '❆';
    snowflake.style.left = Math.random() * 100 + 'vw';
    snowflake.style.fontSize = (Math.random() * 16 + 12) + 'px';
    snowflake.style.animationDuration = (Math.random() * 10 + 10) + 's, ' + ((Math.random() * 4) + 3) + 's';
    snowflake.style.animationDelay = '0s, ' + (Math.random() * 4) + 's';
    document.body.appendChild(snowflake);
    setTimeout(() => {
      snowflake.remove();
    }, 15000);
  }
  setInterval(createSnowflake, 200);

  // Shooting stars container and logic
  const shootingStarsContainer = document.getElementById('shooting-stars-container');
  function createShootingStar() {
    const star = document.createElement('div');
    star.classList.add('shooting-star');
    star.style.top = (Math.random() * 40 + 10) + 'vh';
    star.style.left = '100vw';
    star.style.opacity = Math.random() * 0.5 + 0.5;
    star.style.animationDuration = (Math.random() * 1.2 + 2.5) + 's';
    shootingStarsContainer.appendChild(star);
    star.animate(
      [
        { transform: 'translateX(0) translateY(0) rotate(-45deg)', opacity: star.style.opacity },
        { transform: 'translateX(-120vw) translateY(50vh) rotate(-45deg)', opacity: 0 }
      ],
      { duration: star.style.animationDuration.replace('s', '') * 1000, easing: 'ease-in-out' }
    ).onfinish = () => star.remove();
  }
  setInterval(createShootingStar, 3500);

  // Navigation toggle logic
  const navButtons = document.querySelectorAll('nav ul li button');
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      // Close all
      navButtons.forEach(b => {
        b.setAttribute('aria-expanded', 'false');
        document.getElementById(b.id.replace('btn', b.id.replace('btn', '').toLowerCase() + '-content')).classList.remove('active');
      });
      // Open clicked only if it was closed
      if (!expanded) {
        btn.setAttribute('aria-expanded', 'true');
        document.getElementById(btn.id.replace('btn', btn.id.replace('btn', '').toLowerCase() + '-content')).classList.add('active');
      }
    });
  });

  // Document Storage and Upload with localStorage
  const fileInput = document.getElementById('file-input');
  const uploadBtn = document.getElementById('upload-btn');
  const uploadedFilesContainer = document.getElementById('uploaded-files');
  const uploadStatus = document.getElementById('upload-status');

  function loadFiles() {
    let files = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
    if(files.length === 0) {
      uploadedFilesContainer.innerHTML = "<p>Không có tài liệu nào được tải lên.</p>";
    } else {
      const ul = document.createElement('ul');
      files.forEach((file, i) => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = file.name;
        const btn = document.createElement('button');
        btn.textContent = 'Xóa';
        btn.setAttribute('aria-label', 'Xóa ' + file.name);
        btn.addEventListener('click', () => {
          files.splice(i,1);
          localStorage.setItem('uploadedFiles', JSON.stringify(files));
          loadFiles();
        });
        li.appendChild(span);
        li.appendChild(btn);
        ul.appendChild(li);
      });
      uploadedFilesContainer.innerHTML = '';
      uploadedFilesContainer.appendChild(ul);
    }
  }

  uploadBtn.addEventListener('click', () => {
    const file = fileInput.files[0];
    if(!file){
      uploadStatus.textContent = 'Vui lòng chọn một tập tin!';
      uploadStatus.style.color = 'red';
      return;
    }
    let files = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
    files.push({name: file.name});
    localStorage.setItem('uploadedFiles', JSON.stringify(files));
    uploadStatus.textContent = 'Tập tin "' + file.name + '" đã được lưu trong trình duyệt.';
    uploadStatus.style.color = 'limegreen';
    fileInput.value = '';
    loadFiles();
  });

  loadFiles();

  // Bubble Pop Game variables and logic
  const bubbleGame = document.getElementById('bubble-game');
  const bubbleScoreEl = document.getElementById('bubble-score');
  const bubblePlayBtn = document.getElementById('bubble-play');
  const bubbleResetBtn = document.getElementById('bubble-reset');

  let bubbleScore = 0;
  let bubbleInterval;
  let bubbles = [];
  let bubbleRunning = false;

  function createBubble() {
    if (!bubbleRunning) return;
    const bubble = document.createElement('div');
    bubble.classList.add('bubble');
    const size = Math.random() * 40 + 30;
    bubble.style.width = size + 'px';
    bubble.style.height = size + 'px';
    bubble.style.left = Math.random() * (bubbleGame.clientWidth - size) + 'px';
    bubble.style.bottom = '-'+ size + 'px';
    bubble.style.animationDuration = (Math.random()*5 + 5) + 's';
    bubbleGame.appendChild(bubble);

    function popBubble() {
      bubble.removeEventListener('click', popBubble);
      bubble.classList.add('pop');
      bubble.style.pointerEvents = 'none';
      bubbleScore++;
      bubbleScoreEl.textContent = bubbleScore;
      setTimeout(() => {
        if(bubble.parentNode) bubbleGame.removeChild(bubble);
        bubbles = bubbles.filter(b => b !== bubble);
      }, 300);
    }

    bubble.addEventListener('click', popBubble);
    bubbles.push(bubble);

    bubble.addEventListener('animationend', () => {
      if(bubble.parentNode) {
        bubbleGame.removeChild(bubble);
        bubbles = bubbles.filter(b => b !== bubble);
      }
    });
  }

  function startBubbleGame(){
    if(bubbleRunning) return;
    bubbleRunning = true;
    bubbleScore = 0;
    bubbleScoreEl.textContent = bubbleScore;
    bubblePlayBtn.disabled = true;
    bubbleResetBtn.disabled = false;
    bubbleInterval = setInterval(createBubble, 700);
  }

  function stopBubbleGame(){
    bubbleRunning = false;
    bubblePlayBtn.disabled = false;
    bubbleResetBtn.disabled = true;
    clearInterval(bubbleInterval);
    bubbles.forEach(bubble => {
      if(bubble.parentNode) bubbleGame.removeChild(bubble);
    });
    bubbles = [];
  }

  bubblePlayBtn.addEventListener('click', () => startBubbleGame());
  bubbleResetBtn.addEventListener('click', () => {
    stopBubbleGame();
    startBubbleGame();
  });

  // Obstacle Game variables and logic (Mario style shapes)
  const canvas = document.getElementById('obstacle-canvas');
  const ctx = canvas.getContext('2d');
  const obstaclePlayBtn = document.getElementById('obstacle-play');
  const obstacleResetBtn = document.getElementById('obstacle-reset');
  const obstacleScoreEl = document.getElementById('obstacle-score');

  let runner = {
    x: 50,
    y: 0,
    width: 40,
    height: 60,
    velocityY: 0,
    gravity: 1.2,
    jumpForce: -18,
    grounded: false,
  };
  const groundLevel = canvas.height - runner.height;

  let obstacles = [];
  let obstacleSpeed = 6;
  let spawnTimer = 0;
  let spawnInterval = 90;
  let obstacleRunning = false;
  let score = 0;

  function drawRunner() {
    ctx.fillStyle = '#1565c0';
    ctx.fillRect(runner.x + 5, runner.y + 20, runner.width - 10, runner.height - 20);

    ctx.fillStyle = '#d32f2f';
    ctx.fillRect(runner.x, runner.y + 20, 10, runner.height - 20);

    ctx.fillStyle = '#ffe0bd';
    ctx.beginPath();
    ctx.ellipse(runner.x + runner.width / 2, runner.y + 10, 14, 18, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = '#d32f2f';
    ctx.beginPath();
    ctx.ellipse(runner.x + runner.width / 2, runner.y + 2, 18, 10, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = '#b71c1c';
    ctx.fillRect(runner.x + 18, runner.y + 8, 20, 5);
  }

  function drawMushroom(x, y, width, height) {
    ctx.fillStyle = '#f5f5dc';
    ctx.fillRect(x + width*0.35, y + height*0.5, width * 0.3, height * 0.5);
    ctx.beginPath();
    ctx.ellipse(x + width*0.5, y + height*0.3, width*0.5, height*0.5, 0, 0, Math.PI*2);
    ctx.fillStyle = '#d32f2f';
    ctx.fill();
    ctx.fillStyle = 'white';
    const dots = [
      [x + width*0.35, y + height*0.25],
      [x + width*0.60, y + height*0.15],
      [x + width*0.70, y + height*0.40],
      [x + width*0.45, y + height*0.45]
    ];
    dots.forEach(([cx, cy]) => {
      ctx.beginPath();
      ctx.ellipse(cx, cy, 5, 3.5, 0, 0, Math.PI * 2);
      ctx.fill();
    });
  }

  function drawAuroraBackground() {
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#1e2d52');
    gradient.addColorStop(0.3, '#1a5cc3');
    gradient.addColorStop(0.6, '#2a81f7');
    gradient.addColorStop(1, '#0e3d59');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    for(let i=0; i<5; i++) {
      let x = (canvas.width/5)*i + 40;
      let gradientLine = ctx.createRadialGradient(x, 0, 20, x, canvas.height, 200);
      gradientLine.addColorStop(0, 'rgba(138, 255, 221, 0.3)');
      gradientLine.addColorStop(1, 'transparent');
      ctx.fillStyle = gradientLine;
      ctx.fillRect(x-100, 0, 200, canvas.height);
    }
  }

  let shootingStars = [];
  function createShootingStar() {
    shootingStars.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height / 2,
      length: 100 + Math.random() * 50,
      speedX: 8 + Math.random() * 4,
      speedY: 3 + Math.random() * 2,
      opacity: 1,
      decay: 0.015 + Math.random() * 0.01,
    });
  }
  function updateShootingStars() {
    for(let i = shootingStars.length - 1; i >= 0; i--) {
      const s = shootingStars[i];
      s.x -= s.speedX;
      s.y += s.speedY;
      s.opacity -= s.decay;
      if(s.opacity <= 0 || s.x < 0 || s.y > canvas.height){
        shootingStars.splice(i,1);
      }
    }
  }
  function drawShootingStars() {
    shootingStars.forEach(s => {
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,"+s.opacity.toFixed(2)+")";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(s.x, s.y);
      ctx.lineTo(s.x + s.length, s.y - s.length * 0.3);
      ctx.stroke();
      ctx.restore();
    });
  }

  setInterval(() => {
    if (obstacleRunning && shootingStars.length < 8) createShootingStar();
  }, 500);

  function resetObstacleGame(){
    runner.y = groundLevel;
    runner.velocityY = 0;
    runner.grounded = true;
    obstacles = [];
    spawnTimer = 0;
    score = 0;
    obstacleSpeed = 6;
    obstacleScoreEl.textContent = score;
  }

  function createObstacle(){
    const size = 50;
    obstacles.push({
      x: canvas.width,
      y: groundLevel + 10,
      width: size,
      height: size,
    });
  }

  function updateObstacle(){
    if(!obstacleRunning) return;

    drawAuroraBackground();
    updateShootingStars();
    drawShootingStars();

    ctx.fillStyle = '#1c2733';
    ctx.fillRect(0, groundLevel + runner.height, canvas.width, canvas.height - groundLevel);

    runner.velocityY += runner.gravity;
    runner.y += runner.velocityY;
    if(runner.y > groundLevel){
      runner.y = groundLevel;
      runner.velocityY = 0;
      runner.grounded = true;
    }

    drawRunner();

    spawnTimer++;
    if(spawnTimer >= spawnInterval){
      spawnTimer = 0;
      createObstacle();
    }

    for(let i = obstacles.length - 1; i >=0; i--){
      let obs = obstacles[i];
      obs.x -= obstacleSpeed;
      drawMushroom(obs.x, obs.y - obs.height, obs.width, obs.height);

      if(runner.x < obs.x + obs.width &&
         runner.x + runner.width > obs.x &&
         runner.y + runner.height > obs.y - obs.height &&
         runner.y < obs.y){
          obstacleRunning = false;
          alert('Bạn đã va chạm cây nấm! Điểm: ' + score + '\nNhấn OK để chơi lại.');
          resetObstacleGame();
          obstaclePlayBtn.disabled = false;
          obstacleResetBtn.disabled = true;
          ctx.clearRect(0,0,canvas.width,canvas.height);
          return;
      }

      if(obs.x + obs.width < 0){
        obstacles.splice(i,1);
        score++;
        obstacleScoreEl.textContent = score;
        if(score % 10 === 0) obstacleSpeed += 0.5;
      }
    }
    requestAnimationFrame(updateObstacle);
  }

  function jumpObstacle(){
    if(runner.grounded){
      runner.velocityY = runner.jumpForce;
      runner.grounded = false;
    }
  }

  obstaclePlayBtn.addEventListener('click', () => {
    if(obstacleRunning) return;
    obstacleRunning = true;
    obstaclePlayBtn.disabled = true;
    obstacleResetBtn.disabled = false;
    resetObstacleGame();
    updateObstacle();
  });

  obstacleResetBtn.addEventListener('click', () => {
    obstacleRunning = false;
    obstaclePlayBtn.disabled = false;
    obstacleResetBtn.disabled = true;
    resetObstacleGame();
    ctx.clearRect(0,0,canvas.width,canvas.height);
  });

  document.addEventListener('keydown', e => {
    if(e.code === 'Space'){
      e.preventDefault();
      jumpObstacle();
    }
  });
  canvas.addEventListener('touchstart', e => {
    jumpObstacle();
  });

  // Music player controls
  const musicUrlInput = document.getElementById('music-url');
  const loadMusicBtn = document.getElementById('load-music');
  const musicContainer = document.getElementById('music-container');
  let currentIframe = null;

  // Load default Fake Love instrumental (YouTube embed URL)
  const defaultEmbedUrl = "https://www.youtube.com/embed/fnCSI0btU1E?autoplay=1&controls=1&loop=1&playlist=fnCSI0btU1E";
  function loadMusic(src) {
    musicContainer.innerHTML = '';
    const iframe = document.createElement('iframe');
    iframe.setAttribute('src', src);
    iframe.setAttribute('width', '100%');
    iframe.setAttribute('height', '80');
    iframe.setAttribute('frameborder', '0');
    iframe.setAttribute('allow', 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture');
    iframe.setAttribute('allowfullscreen', '');
    musicContainer.appendChild(iframe);
    currentIframe = iframe;
  }
  loadMusic(defaultEmbedUrl);

  loadMusicBtn.addEventListener('click', () => {
    const url = musicUrlInput.value.trim();
    if (!url) {
      alert('Vui lòng nhập URL hợp lệ!');
      return;
    }
    let embedUrl = null;

    if (url.includes('youtube.com') || url.includes('youtu.be')) {
      const videoIdMatch = url.match(/(youtu.be\/|v=|\/embed\/)([a-zA-Z0-9_-]{11})/);
      let videoId = null;
      if(videoIdMatch){
        videoId = videoIdMatch[2];
      } else {
        try {
          const urlObj = new URL(url);
          videoId = urlObj.searchParams.get('v');
        } catch {
          videoId = null;
        }
      }
      if(videoId){
        embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1`;
      } else {
        alert('Không thể nhận dạng video YouTube. Vui lòng nhập URL thành các dạng chuẩn.');
        return;
      }
    } else if (url.includes('open.spotify.com')) {
      try {
        const urlObj = new URL(url);
        const parts = urlObj.pathname.split('/');
        if(parts.length >= 3){
          const type = parts[1];
          const id = parts[2];
          embedUrl = `https://open.spotify.com/embed/${type}/${id}`;
        }
      } catch {
        alert('URL Spotify không hợp lệ.');
        return;
      }
    } else {
      alert('Chỉ hỗ trợ URL YouTube và Spotify.');
      return;
    }

    if(embedUrl){
      loadMusic(embedUrl);
    }
  });

  // Volume control for iframe audio is restricted cross origin, so use YouTube Player API or disclaim no direct volume control possible
  // We will implement volume slider that controls the iframe audio volume using YouTube API if available, else notify user.
  const volumeControl = document.getElementById('volume-control');
  volumeControl.addEventListener('input', (e) => {
    let vol = e.target.value;
    // Without YouTube API, cannot control volume directly on iframe
    // Notify user
    if(currentIframe){
      alert('Điều chỉnh âm lượng nhạc chỉ hoạt động khi dùng YouTube API (không hỗ trợ iframe âm nhạc thông thường).');
    }
  });
</script>
</body>
</html>

